<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Convert Incomplete Date Strings - Practical MongoDB Aggregations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../cover-page.html">Practical MongoDB Aggregations</a></li><li class="chapter-item expanded affix "><a href="../../credits.html">Credits</a></li><li class="chapter-item expanded "><a href="../../intro/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../intro/history.html"><strong aria-hidden="true">1.1.</strong> History</a></li></ol></li><li class="chapter-item expanded "><a href="../../guides/00-guides.html"><strong aria-hidden="true">2.</strong> Guiding Tips &amp; Principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/getting-started.html"><strong aria-hidden="true">2.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../../guides/getting-help.html"><strong aria-hidden="true">2.2.</strong> Getting Help</a></li><li class="chapter-item expanded "><a href="../../guides/composibility.html"><strong aria-hidden="true">2.3.</strong> Embrace Composibility For Increased Productivity</a></li><li class="chapter-item expanded "><a href="../../guides/project.html"><strong aria-hidden="true">2.4.</strong> To Project Or Not To Project, That Is The Question</a></li><li class="chapter-item expanded "><a href="../../guides/explain.html"><strong aria-hidden="true">2.5.</strong> Using Explain Plans</a></li><li class="chapter-item expanded "><a href="../../guides/performance.html"><strong aria-hidden="true">2.6.</strong> Pipeline Performance Considerations</a></li><li class="chapter-item expanded "><a href="../../guides/expressions.html"><strong aria-hidden="true">2.7.</strong> Can Expressions By Used Everywhere?</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/examples.html"><strong aria-hidden="true">3.</strong> Aggregations By Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/simple-examples/00-simple-examples.html"><strong aria-hidden="true">3.1.</strong> Simple Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/simple-examples/filtered-top-subset.html"><strong aria-hidden="true">3.1.1.</strong> Filtered Top Subset</a></li><li class="chapter-item expanded "><a href="../../examples/simple-examples/group-and-total.html"><strong aria-hidden="true">3.1.2.</strong> Group &amp; Total</a></li><li class="chapter-item expanded "><a href="../../examples/simple-examples/unpack-array-group-differently.html"><strong aria-hidden="true">3.1.3.</strong> Unpack Arrays &amp; Group Differently</a></li><li class="chapter-item expanded "><a href="../../examples/simple-examples/one-to-one-join.html"><strong aria-hidden="true">3.1.4.</strong> One-to-One Join</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/moderate-examples/00-moderate-examples.html"><strong aria-hidden="true">3.2.</strong> Moderate Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/moderate-examples/multi-one-to-many.html"><strong aria-hidden="true">3.2.1.</strong> Multi-Field Join &amp; One-to-Many</a></li><li class="chapter-item expanded "><a href="../../examples/moderate-examples/mask-sensitive-fields.html"><strong aria-hidden="true">3.2.2.</strong> Mask Sensitive Fields</a></li><li class="chapter-item expanded "><a href="../../examples/moderate-examples/largest-graph-network.html"><strong aria-hidden="true">3.2.3.</strong> Largest Graph Network</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/intricate-examples/00-intricate-examples.html"><strong aria-hidden="true">3.3.</strong> Intricate Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/intricate-examples/restricted-view.html"><strong aria-hidden="true">3.3.1.</strong> Restricted View</a></li><li class="chapter-item expanded "><a href="../../examples/intricate-examples/convert-incomplete-dates.html" class="active"><strong aria-hidden="true">3.3.2.</strong> Convert Incomplete Date Strings</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Practical MongoDB Aggregations</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="convert-incomplete-date-strings"><a class="header" href="#convert-incomplete-date-strings">Convert Incomplete Date Strings</a></h1>
<p><strong>Minimum MongoDB Version:</strong> 4.2</p>
<h2 id="scenario"><a class="header" href="#scenario">Scenario</a></h2>
<p>A user wants to transform some text fields that contain some date-time related information to into date typed fields. It is always desirable to convert such text fields to date fields to subsequently be able to easily perform date range queries and date sorted ordering. Usually this conversion would be achieved using MongoDB's rich set of <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/#date-expression-operators">Date Expression Operators</a>. However, the specific date-time text values provided are incomplete and don't contain all the information required to determine things like which century the date is for, and which time zone it is for. As a result, MongoDB's <em>out-of-the-box</em> date expression operators cannot be used.</p>
<p>In this example, a collection of <em>payments</em> documents exists, each with a <code>payment_date</code> text field which contains strings that look vaguely like date-times, such as <code>01-JAN-20 01.01.01.123000000</code> for example, and which need to be converted to proper dates. However as you can see, the field's value doesn't contain all the information required to accurately know the exact date-time this corresponds to (these values may have originated from a baldy exported dump from a relational database, for example, and have then just been imported into MongoDB as-is). The missing date-time information in these text fields is:</p>
<ul>
<li>The specific <strong>century</strong> (1900s?, 2000s, other?)</li>
<li>The specific <strong>time-zone</strong> (GMT?, IST?, PST?, other?) </li>
<li>The specific <strong>language</strong> that the three letter month abbreviation is in (is 'JAN' in French? in English? other?)</li>
</ul>
<p>For this example, the developer is armed with additional context that the database and data-set does not have. The developer is told that all the records are for the <strong>21st century</strong> only, the time-zone used when the data was exported was <strong>UTC</strong> and the language used when exported was <strong>English</strong>. Armed with this additional information, the developer is able to build and execute an aggregation pipeline to transform each of the date-related text fields to become fully-formed date types.</p>
<h2 id="sample-data-population"><a class="header" href="#sample-data-population">Sample Data Population</a></h2>
<p>Drop the old version of the database (if it exists) and then populate a new <em>payments</em> collection with 12 sample payments documents to test, providing coverage across all 12 months for the year 2020, with random time elements.</p>
<pre><code class="language-javascript">use convert-incomplete-dates;
db.dropDatabase();

// Insert 12 records into the payments collection
db.payments.insert([
  {'account': '010101', 'payment_date': '01-JAN-20 01.01.01.123000000', 'amount': 1.01},
  {'account': '020202', 'payment_date': '02-FEB-20 02.02.02.456000000', 'amount': 2.02},
  {'account': '030303', 'payment_date': '03-MAR-20 03.03.03.789000000', 'amount': 3.03},
  {'account': '040404', 'payment_date': '04-APR-20 04.04.04.012000000', 'amount': 4.04},
  {'account': '050505', 'payment_date': '05-MAY-20 05.05.05.345000000', 'amount': 5.05},
  {'account': '060606', 'payment_date': '06-JUN-20 06.06.06.678000000', 'amount': 6.06},
  {'account': '070707', 'payment_date': '07-JUL-20 07.07.07.901000000', 'amount': 7.07},
  {'account': '080808', 'payment_date': '08-AUG-20 08.08.08.234000000', 'amount': 8.08},
  {'account': '090909', 'payment_date': '09-SEP-20 09.09.09.567000000', 'amount': 9.09},
  {'account': '101010', 'payment_date': '10-OCT-20 10.10.10.890000000', 'amount': 10.10},
  {'account': '111111', 'payment_date': '11-NOV-20 11.11.11.111000000', 'amount': 11.11},
  {'account': '121212', 'payment_date': '12-DEC-20 12.12.12.999000000', 'amount': 12.12}
]);
</code></pre>
<h2 id="aggregation-pipelines"><a class="header" href="#aggregation-pipelines">Aggregation Pipeline(s)</a></h2>
<p>Define a single pipeline ready to perform the aggregation:</p>
<pre><code class="language-javascript">var pipeline = [
  // Change field from a string to a date, filling in the missing gaps
  {'$set': {
    'payment_date': {    
      '$let': {
        'vars': {
          'txt': '$payment_date',  // Assign 'payment_date' field to variable 'txt'
        },
        'in': { 
          '$dateFromString': {'format': '%d-%m-%Y %H.%M.%S.%L', 'dateString':
            {'$concat': [
              {'$substrCP': ['$$txt', 0, 3]},  // Use 1st 3 chars in string
              {'$switch': {'branches': [  // Replace month 3 chars with month number
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'JAN']}, 'then': '01'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'FEB']}, 'then': '02'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'MAR']}, 'then': '03'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'APR']}, 'then': '04'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'MAY']}, 'then': '05'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'JUN']}, 'then': '06'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'JUL']}, 'then': '07'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'AUG']}, 'then': '08'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'SEP']}, 'then': '09'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'OCT']}, 'then': '10'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'NOV']}, 'then': '11'},
                {'case': {'$eq': [{'$substrCP': ['$$txt', 3, 3]}, 'DEC']}, 'then': '12'},
               ], 'default': 'ERROR'}},
              '-20',  // Add hyphen + hardcoded century 2 digits
              {'$substrCP': ['$$txt', 7, 15]}  // Use remaining 3 millis (ignore last 6 nanosecs)
            ]
          }}                  
        }
      }        
    },             
  }},

  // Omit unwanted fields
  {'$unset': [
    '_id',
  ]},         
];
</code></pre>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<p>Execute the aggregation using the defined pipeline and also view its explain plan:</p>
<pre><code class="language-javascript">db.payments.aggregate(pipeline);
</code></pre>
<pre><code class="language-javascript">db.payments.explain('executionStats').aggregate(pipeline);
</code></pre>
<h2 id="expected-results"><a class="header" href="#expected-results">Expected Results</a></h2>
<p>Twelve documents should be returned, corresponding to the original twelve source documents, but this time with the <code>payment_date</code> field converted from text values to proper date typed values, as shown below:</p>
<pre><code class="language-javascript">[
  {
    account: '010101',
    payment_date: 2020-01-01T01:01:01.123Z,
    amount: 1.01
  },
  {
    account: '020202',
    payment_date: 2020-02-02T02:02:02.456Z,
    amount: 2.02
  },
  {
    account: '030303',
    payment_date: 2020-03-03T03:03:03.789Z,
    amount: 3.03
  },
  {
    account: '040404',
    payment_date: 2020-04-04T04:04:04.012Z,
    amount: 4.04
  },
  {
    account: '050505',
    payment_date: 2020-05-05T05:05:05.345Z,
    amount: 5.05
  },
  {
    account: '060606',
    payment_date: 2020-06-06T06:06:06.678Z,
    amount: 6.06
  },
  {
    account: '070707',
    payment_date: 2020-07-07T07:07:07.901Z,
    amount: 7.07
  },
  {
    account: '080808',
    payment_date: 2020-08-08T08:08:08.234Z,
    amount: 8.08
  },
  {
    account: '090909',
    payment_date: 2020-09-09T09:09:09.567Z,
    amount: 9.09
  },
  {
    account: '101010',
    payment_date: 2020-10-10T10:10:10.890Z,
    amount: 10.1
  },
  {
    account: '111111',
    payment_date: 2020-11-11T11:11:11.111Z,
    amount: 11.11
  },
  {
    account: '121212',
    payment_date: 2020-12-12T12:12:12.999Z,
    amount: 12.12
  }
]
</code></pre>
<h2 id="observations--comments"><a class="header" href="#observations--comments">Observations &amp; Comments</a></h2>
<ul>
<li>
<p><strong>Concatenation Explanation.</strong> In this pipeline, the text fields (e.g. <code>12-DEC-20 12.12.12.999000000</code>) are each converted to date fields (e.g. <code>2020-12-12T12:12:12.999Z</code>) by concatenating together the following four elements extracted from the text field, before passing it to the <code>$dateFromString</code> operator to convert to a date type:</p>
<ul>
<li><code>'12-'</code> <em>(day of month from the input string)</em></li>
<li><code>'12'</code> <em>(replacing 'DEC')</em></li>
<li><code>'-20'</code> <em>(hard-coded hyphen + century)</em></li>
<li><code>'20 12.12.12.999'</code> <em>(the rest of input string apart from the last 6 nanosecond digits)</em></li>
</ul>
</li>
<li>
<p><strong>Further Reading.</strong> This example is actually based on the output of the blog post: <a href="https://pauldone.blogspot.com/2020/05/aggregation-convert-nasty-date-strings.html">Converting Gnarly Date Strings to Proper Date Types Using a MongoDB Aggregation Pipeline</a></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../examples/intricate-examples/restricted-view.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../examples/intricate-examples/restricted-view.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
