<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Restricted View - Practical MongoDB Aggregations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../cover-page.html">Practical MongoDB Aggregations</a></li><li class="chapter-item expanded affix "><a href="../../credits.html">Credits</a></li><li class="chapter-item expanded "><a href="../../intro/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../intro/history.html"><strong aria-hidden="true">1.1.</strong> History</a></li></ol></li><li class="chapter-item expanded "><a href="../../guides/00-guides.html"><strong aria-hidden="true">2.</strong> Guiding Tips &amp; Principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/getting-started.html"><strong aria-hidden="true">2.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../../guides/getting-help.html"><strong aria-hidden="true">2.2.</strong> Getting Help</a></li><li class="chapter-item expanded "><a href="../../guides/composibility.html"><strong aria-hidden="true">2.3.</strong> Embrace Composibility For Increased Productivity</a></li><li class="chapter-item expanded "><a href="../../guides/project.html"><strong aria-hidden="true">2.4.</strong> To Project Or Not To Project, That Is The Question</a></li><li class="chapter-item expanded "><a href="../../guides/explain.html"><strong aria-hidden="true">2.5.</strong> Using Explain Plans</a></li><li class="chapter-item expanded "><a href="../../guides/performance.html"><strong aria-hidden="true">2.6.</strong> Pipeline Performance Considerations</a></li><li class="chapter-item expanded "><a href="../../guides/expressions.html"><strong aria-hidden="true">2.7.</strong> Can Expressions By Used Everywhere?</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/examples.html"><strong aria-hidden="true">3.</strong> Aggregations By Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/simple-examples/00-simple-examples.html"><strong aria-hidden="true">3.1.</strong> Simple Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/simple-examples/filtered-top-subset.html"><strong aria-hidden="true">3.1.1.</strong> Filtered Top Subset</a></li><li class="chapter-item expanded "><a href="../../examples/simple-examples/group-and-total.html"><strong aria-hidden="true">3.1.2.</strong> Group &amp; Total</a></li><li class="chapter-item expanded "><a href="../../examples/simple-examples/unpack-array-group-differently.html"><strong aria-hidden="true">3.1.3.</strong> Unpack Arrays &amp; Group Differently</a></li><li class="chapter-item expanded "><a href="../../examples/simple-examples/one-to-one-join.html"><strong aria-hidden="true">3.1.4.</strong> One-to-One Join</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/moderate-examples/00-moderate-examples.html"><strong aria-hidden="true">3.2.</strong> Moderate Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/moderate-examples/multi-one-to-many.html"><strong aria-hidden="true">3.2.1.</strong> Multi-Field Join &amp; One-to-Many</a></li><li class="chapter-item expanded "><a href="../../examples/moderate-examples/mask-sensitive-fields.html"><strong aria-hidden="true">3.2.2.</strong> Mask Sensitive Fields</a></li><li class="chapter-item expanded "><a href="../../examples/moderate-examples/largest-graph-network.html"><strong aria-hidden="true">3.2.3.</strong> Largest Graph Network</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/intricate-examples/00-intricate-examples.html"><strong aria-hidden="true">3.3.</strong> Intricate Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/intricate-examples/restricted-view.html" class="active"><strong aria-hidden="true">3.3.1.</strong> Restricted View</a></li><li class="chapter-item expanded "><a href="../../examples/intricate-examples/convert-incomplete-dates.html"><strong aria-hidden="true">3.3.2.</strong> Convert Incomplete Date Strings</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Practical MongoDB Aggregations</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="restricted-view"><a class="header" href="#restricted-view">Restricted View</a></h1>
<p><strong>Minimum MongoDB Version:</strong> 4.2</p>
<h2 id="scenario"><a class="header" href="#scenario">Scenario</a></h2>
<p>Users with different roles will need to query the same data-set, but one of the roles specifically should be provided with read-only access only and be restricted to only be able to view a filtered subset of records in a collection and only a subset of fields in each of these records. Essentially this is an example of 'record-level' Role Based Access Control (RBAC).</p>
<p>In this example, a collection of <em>persons</em>, each containing personal information, will have a read-only <em>adults</em> view created for it, based on an aggregation pipeline, which restricts the <em>persons</em> data that can be queried, in two ways:</p>
<ol>
<li>Only return records for people who are aged 18 over over (by checking each person's <code>dateofbirth</code> field)</li>
<li>For each record in the result, exclude the <code>dateofbirth</code> field because this information is sensitive</li>
</ol>
<p>In a real deployment, MongoDB's <a href="https://docs.mongodb.com/manual/core/authorization/">Role-Based Access Control</a> rules would be used to enforce that the restricted user is only able to access the <code>adults</code> view and is not able to access the underlying <code>persons</code> collection.</p>
<h2 id="sample-data-population"><a class="header" href="#sample-data-population">Sample Data Population</a></h2>
<p>Drop the old version of the database (if it exists), create an index and populate the new <code>persons</code> collections with 5 records:</p>
<pre><code class="language-javascript">use restricted-view;
db.dropDatabase();

// Create 2 indexes for a persons collection
db.persons.createIndex({'gender': 1});
db.persons.createIndex({'dateofbirth': -1});

// Insert 5 records into the persons collection
db.persons.insertMany([
  {
    'person_id': '6392529400',
    'firstname': 'Elise',
    'lastname': 'Smith',
    'dateofbirth': ISODate('1972-01-13T09:32:07Z'),
    'gender': 'FEMALE',
    'email': 'elise_smith@myemail.com',
    'address': { 
        'number': 5625,
        'street': 'Tipa Circle',
        'city': 'Wojzinmoj',
    },
  },
  {
    'person_id': '1723338115',
    'firstname': 'Olive',
    'lastname': 'Ranieri',
    'dateofbirth': ISODate('1985-05-12T23:14:30Z'),    
    'gender': 'FEMALE',
    'email': 'oranieri@warmmail.com',
    'address': {
        'number': 9303,
        'street': 'Mele Circle',
        'city': 'Tobihbo',
    },
  },
  {
    'person_id': '8732762874',
    'firstname': 'Toni',
    'lastname': 'Jones',
    'dateofbirth': ISODate('2014-11-23T16:53:56Z'),    
    'gender': 'FEMALE',
    'email': 'tj@wheresmyemail.com',
    'address': {
        'number': 1,
        'street': 'High Street',
        'city': 'Upper Abbeywoodington',
    },
  },
  {
    'person_id': '7363629563',
    'firstname': 'Bert',
    'lastname': 'Gooding',
    'dateofbirth': ISODate('1941-04-07T22:11:52Z'),    
    'gender': 'MALE',
    'email': 'bgooding@tepidmail.com',
    'address': {
        'number': 13,
        'street': 'Upper Bold Road',
        'city': 'Redringtonville',
    },
  },
  {
    'person_id': '1029648329',
    'firstname': 'Sophie',
    'lastname': 'Celements',
    'dateofbirth': ISODate('2013-07-06T17:35:45Z'),    
    'gender': 'FEMALE',
    'email': 'sophe@celements.net',
    'address': {
        'number': 5,
        'street': 'Innings Close',
        'city': 'Basilbridge',
    },
  },
]);
</code></pre>
<h2 id="aggregation-pipelines"><a class="header" href="#aggregation-pipelines">Aggregation Pipeline(s)</a></h2>
<p>Define a single pipeline ready to perform the aggregation:</p>
<pre><code class="language-javascript">var pipeline = [
  // Filter out any persons aged under 18 ($expr required to reference '$$NOW'
  {'$match':
    {'$expr':{
      '$lt': ['$dateofbirth', {'$subtract': ['$$NOW', 18*365.25*24*60*60*1000]}]
    }},
  },

  // Exclude fields to be filtered out by the view
  {'$unset': [
    '_id',
    'dateofbirth',
  ]},    
];
</code></pre>
<h2 id="execution"><a class="header" href="#execution">Execution</a></h2>
<p>First to test the defined aggregation pipeline (before using it to define a view), execute the aggregation for the pipeline and also view its explain plan:</p>
<pre><code class="language-javascript">db.persons.aggregate(pipeline);
</code></pre>
<pre><code class="language-javascript">db.persons.explain('executionStats').aggregate(pipeline);
</code></pre>
<p>Now create the new <em>adults</em> view which will automatically apply the pipeline whenever the view is subsequently queried: </p>
<pre><code class="language-javascript">db.createView('adults', 'persons', pipeline);
</code></pre>
<p>Execute a normal MQL query against the view, without any filter criteria, and also view its explain plan:</p>
<pre><code class="language-javascript">db.adults.find();
</code></pre>
<pre><code class="language-javascript">db.adults.explain('executionStats').find();
</code></pre>
<p>Execute a normal MQL query against the view, but this time with a filter to return only adults who are female, and again view its explain plan to see how the <code>gender</code> filter affects the plan:</p>
<pre><code class="language-javascript">db.adults.find({'gender': 'FEMALE'});
</code></pre>
<pre><code class="language-javascript">db.adults.explain('executionStats').find({'gender': 'FEMALE'});
</code></pre>
<h2 id="expected-results"><a class="header" href="#expected-results">Expected Results</a></h2>
<p>The result for both the <code>aggregate()</code> command and the <code>find()</code> executed on the <em>view</em> should be exactly the same, with three documents returned, representing the three persons who are over 18 but not showing their actual dates of birth, as shown below:</p>
<pre><code class="language-javascript">[
  {
    person_id: '6392529400',
    firstname: 'Elise',
    lastname: 'Smith',
    gender: 'FEMALE',
    email: 'elise_smith@myemail.com',
    address: { number: 5625, street: 'Tipa Circle', city: 'Wojzinmoj' }
  },
  {
    person_id: '1723338115',
    firstname: 'Olive',
    lastname: 'Ranieri',
    gender: 'FEMALE',
    email: 'oranieri@warmmail.com',
    address: { number: 9303, street: 'Mele Circle', city: 'Tobihbo' }
  },
  {
    person_id: '7363629563',
    firstname: 'Bert',
    lastname: 'Gooding',
    gender: 'MALE',
    email: 'bgooding@tepidmail.com',
    address: { number: 13, street: 'Upper Bold Road', city: 'Redringtonville' }
  }
]
</code></pre>
<p>The result of running the <code>find()</code> against the <em>view</em> with the filter <code>'gender': 'FEMALE'</code> should result in only two females' record being return because the male record has been excluded, as shown below:</p>
<pre><code class="language-javascript">[
  {
    person_id: '1723338115',
    firstname: 'Olive',
    lastname: 'Ranieri',
    gender: 'FEMALE',
    email: 'oranieri@warmmail.com',
    address: { number: 9303, street: 'Mele Circle', city: 'Tobihbo' }
  },
  {
    person_id: '6392529400',
    firstname: 'Elise',
    lastname: 'Smith',
    gender: 'FEMALE',
    email: 'elise_smith@myemail.com',
    address: { number: 5625, street: 'Tipa Circle', city: 'Wojzinmoj' }
  }
]
</code></pre>
<h2 id="observations--comments"><a class="header" href="#observations--comments">Observations &amp; Comments</a></h2>
<ul>
<li>
<p><strong>Expr &amp; Indexes.</strong> The <a href="https://docs.mongodb.com/manual/reference/aggregation-variables/">NOW system variable</a> which returns the current system date-time, has been used but this can only be accessed via an <a href="https://docs.mongodb.com/manual/meta/aggregation-quick-reference/#expressions">aggregation expression</a> and not directly via the normal MongoDB query syntax used by both MQL and <code>$match</code>. Therefore, the use of the <code>$$NOW</code> variable has to be wrapped in an <code>$expr</code> operator. The <a href="https://docs.mongodb.com/manual/reference/operator/query/expr/">$expr query operator</a> allows the use of aggregation expressions from within MongoDB's query language, which is otherwise not normally possible. Consequently, as you can inspect in the explain plan for the pipeline, the executed aggregation cannot leverage the defined <code>dateofbirth</code> index meaning that a <em>full collection scan</em> is performed rather than an <em>index scan</em>. For clarity, the following is a direct quote from the <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/match/#definition">MongoDB Manual for $match</a> which details the restriction:</p>
<ul>
<li>&quot;<em>$match takes a document that specifies the query conditions. The query syntax is identical to the read operation query syntax; i.e. $match does not accept raw aggregation expressions. Instead, use a $expr query expression to include aggregation expression in $match</em>&quot;</li>
</ul>
</li>
<li>
<p><strong>Views Finds &amp; Indexes.</strong> If you view the explain plan for running the <code>find()</code> against the <em>view</em> with the <code>'gender'</code> filter however, you will notice that an index has been used (the index defined on the <code>'gender'</code> field). This is because, just as the database engine performs <a href="https://docs.mongodb.com/manual/core/aggregation-pipeline-optimization/">aggregation pipeline optimisations</a> for regular aggregations, including attempting to move <em>match</em> filters to the top of the pipeline, if possible, it can apply these same optimisations on a view. At runtime a view is essentially just an aggregation pipeline that was defined 'ahead of time'. So when <code>db.adults.find({'gender': 'FEMALE'})</code> is executed, the database engine adds a new dynamically generated <code>$match</code> to the end of the pipeline and then the database engine is able to optimise the pipeline and move the new <code>$match</code> stage up to the start of the pipeline, merged, in this case, in with the existing <code>$match</code> (<code>$expr</code>) stage. At runtime the query engine can then target the <code>gender</code> index. Two excerpts from the explain plan are shown below showing how the filter on <code>gender</code> and the filter on <code>dateofbirth</code> have been combined at runtime and then how the existing index for <code>gender</code> is leveraged, resulting in the benefit of the final aggregation performing just a 'partial table scan' rather than a 'full table scan'.</p>
</li>
</ul>
<pre><code class="language-javascript">&quot;$cursor&quot; : {
  &quot;queryPlanner&quot; : {
		&quot;parsedQuery&quot; : {
			&quot;$and&quot; : [
				{
					&quot;gender&quot; : {
						&quot;$eq&quot; : &quot;FEMALE&quot;
					}
				},
				{
					&quot;$expr&quot; : {
						&quot;$lt&quot; : [
							&quot;$dateofbirth&quot;,
							{
								&quot;$subtract&quot; : [
									&quot;$$NOW&quot;,
</code></pre>
<pre><code class="language-javascript">&quot;inputStage&quot; : {
	&quot;stage&quot; : &quot;IXSCAN&quot;,
	&quot;keyPattern&quot; : {
		&quot;gender&quot; : 1
	},
	&quot;indexName&quot; : &quot;gender_1&quot;,
	&quot;direction&quot; : &quot;forward&quot;,
	&quot;indexBounds&quot; : {
		&quot;gender&quot; : [
			&quot;[\&quot;FEMALE\&quot;, \&quot;FEMALE\&quot;]&quot;
		]
	}
}
</code></pre>
<ul>
<li><strong>Further Reading.</strong> This ability for query (<code>find()</code>) operations on a view to automatically have filters pushed into the view's aggregation pipeline as a new <code>$match</code> stage, at runtime, and where possible then be moved to the top of the pipeline by the database engine's optimiser, is described further in the blog post: <a href="https://pauldone.blogspot.com/2020/11/mongdb-views-optimisations.html">Is Querying A MongoDB View Optimised?</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../examples/intricate-examples/00-intricate-examples.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../examples/intricate-examples/convert-incomplete-dates.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../examples/intricate-examples/00-intricate-examples.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../examples/intricate-examples/convert-incomplete-dates.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
