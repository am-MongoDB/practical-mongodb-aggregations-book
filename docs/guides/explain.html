<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Using Explain Plans - Practical MongoDB Aggregations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../cover-page.html">Practical MongoDB Aggregations</a></li><li class="chapter-item expanded affix "><a href="../credits.html">Credits</a></li><li class="chapter-item expanded "><a href="../intro/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro/history.html"><strong aria-hidden="true">1.1.</strong> History</a></li></ol></li><li class="chapter-item expanded "><a href="../guides/00-guides.html"><strong aria-hidden="true">2.</strong> Guiding Tips &amp; Principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guides/getting-started.html"><strong aria-hidden="true">2.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../guides/getting-help.html"><strong aria-hidden="true">2.2.</strong> Getting Help</a></li><li class="chapter-item expanded "><a href="../guides/composibility.html"><strong aria-hidden="true">2.3.</strong> Embrace Composibility For Increased Productivity</a></li><li class="chapter-item expanded "><a href="../guides/project.html"><strong aria-hidden="true">2.4.</strong> To Project Or Not To Project, That Is The Question</a></li><li class="chapter-item expanded "><a href="../guides/explain.html" class="active"><strong aria-hidden="true">2.5.</strong> Using Explain Plans</a></li><li class="chapter-item expanded "><a href="../guides/performance.html"><strong aria-hidden="true">2.6.</strong> Pipeline Performance Considerations</a></li><li class="chapter-item expanded "><a href="../guides/expressions.html"><strong aria-hidden="true">2.7.</strong> Can Expressions By Used Everywhere?</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/examples.html"><strong aria-hidden="true">3.</strong> Aggregations By Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/simple-examples/00-simple-examples.html"><strong aria-hidden="true">3.1.</strong> Simple Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/simple-examples/filtered-top-subset.html"><strong aria-hidden="true">3.1.1.</strong> Filtered Top Subset</a></li><li class="chapter-item expanded "><a href="../examples/simple-examples/group-and-total.html"><strong aria-hidden="true">3.1.2.</strong> Group &amp; Total</a></li><li class="chapter-item expanded "><a href="../examples/simple-examples/unpack-array-group-differently.html"><strong aria-hidden="true">3.1.3.</strong> Unpack Arrays &amp; Group Differently</a></li><li class="chapter-item expanded "><a href="../examples/simple-examples/one-to-one-join.html"><strong aria-hidden="true">3.1.4.</strong> One-to-One Join</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/moderate-examples/00-moderate-examples.html"><strong aria-hidden="true">3.2.</strong> Moderate Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/moderate-examples/multi-one-to-many.html"><strong aria-hidden="true">3.2.1.</strong> Multi-Field Join &amp; One-to-Many</a></li><li class="chapter-item expanded "><a href="../examples/moderate-examples/mask-sensitive-fields.html"><strong aria-hidden="true">3.2.2.</strong> Mask Sensitive Fields</a></li><li class="chapter-item expanded "><a href="../examples/moderate-examples/largest-graph-network.html"><strong aria-hidden="true">3.2.3.</strong> Largest Graph Network</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/intricate-examples/00-intricate-examples.html"><strong aria-hidden="true">3.3.</strong> Intricate Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/intricate-examples/restricted-view.html"><strong aria-hidden="true">3.3.1.</strong> Restricted View</a></li><li class="chapter-item expanded "><a href="../examples/intricate-examples/convert-incomplete-dates.html"><strong aria-hidden="true">3.3.2.</strong> Convert Incomplete Date Strings</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Practical MongoDB Aggregations</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="using-explain-plans"><a class="header" href="#using-explain-plans">Using Explain Plans</a></h1>
<p>Often, when using the MongoDB Query Language (MQL) to develop queries, it is useful to view the <a href="https://docs.mongodb.com/manual/reference/method/db.collection.explain/">explain plan</a> for the query to determine whether the right indexes were used and whether other aspects of the query are fully optimised. An explain plan allows you to better understand the performance implications of the query you have created.</p>
<p>The same applies to aggregation pipelines and the ability to view an <em>explain plan</em> for the executed pipeline. However, with aggregations, an explain plan tends to be even more critical because much more complex logic can be assembled and then executed in the database. Consequently, there are more potential areas for performance bottlenecks to occur, requiring optimisation. As discussed earlier in this book, the MongoDB database engine will do its best to apply its own <a href="https://docs.mongodb.com/manual/core/aggregation-pipeline-optimization/">aggregation pipeline optimisations</a> at runtime but there will always be some types of optimisations that only the developer can make. This is because a database engine should never optimise a pipeline in such a way that it risks changing the functional behaviour and outcome of the pipeline. The database engine doesn't have the extra context that a developer's brain has, relating to the actual business problem at hand, and is thus unable to make some types of judgement calls about what pipeline changes to apply to make it run faster. This is where the explain plan for aggregations comes in useful for developers. It allows the developer to understand what optimisations the database engine has made and to then spot further potential optimisations that can be manually made to the pipeline (in addition to just identifying missing indexes).</p>
<h2 id="viewing-an-explain-plan"><a class="header" href="#viewing-an-explain-plan">Viewing An Explain Plan</a></h2>
<p>To view the explain plan for an aggregation pipeline, a developer can execute statements such as the following:</p>
<pre><code class="language-javascript">db.coll.explain().aggregate([{'$match': {'name': 'Jo'}}]);
</code></pre>
<p>However, in this book you will already have seen the convention being used to, firstly, define a separate variable for the pipeline, followed by the call to the <code>aggregate()</code> function, passing in the pipeline argument, as shown here:</p>
<pre><code class="language-javascript">db.coll.aggregate(pipeline);
</code></pre>
<p>By using this approach, it easier to use the same defined pipeline variable interchangeably, with different commands. For example, whilst prototyping and debugging a pipeline it is handy to be able to quickly switch from executing the pipeline to instead generating the explain plan, for the same defined pipeline, as follows:</p>
<pre><code class="language-javascript">db.coll.explain().aggregate(pipeline);
</code></pre>
<p>As with MQL, there are three different verbosity modes that an aggregation's explain plan can be generated with, as shown below:</p>
<pre><code class="language-javascript">// QueryPlanner verbosity  (default if no verbosity parameter provided)
db.coll.explain('queryPlanner').aggregate(pipeline);
</code></pre>
<pre><code class="language-javascript">// ExecutionStats verbosity
db.coll.explain('executionStats').aggregate(pipeline);
</code></pre>
<pre><code class="language-javascript">// AllPlansExecution verbosity 
db.coll.explain('allPlansExecution').aggregate(pipeline);
</code></pre>
<p>In most cases, running the <code>executionStats</code> variant is the most useful to developers because, rather than showing just the query planner's 'thinking', it also provides real statistics on the 'winning' executed plan (e.g. the total keys examined, the total docs examined, etc.). However, this isn't the default because it actually executes the aggregation too, in addition to formulating the query plan, which, if the source collection is large and/or the pipeline is sub-optimal, could take a while to return with the explain plan result.</p>
<p>Note, the <a href="https://docs.mongodb.com/manual/reference/method/db.collection.aggregate/">aggregate()</a> function also provides a vestigial <code>explain</code> parameter option to enable an explain plan to be generated and returned. However this is more limited and cumbersome to use, and so nowadays is best avoided.</p>
<h2 id="understanding-the-explain-plan"><a class="header" href="#understanding-the-explain-plan">Understanding The Explain Plan</a></h2>
<p>As an example, let's assume there is a data-set of information on people (e.g. a collection called <em>persons</em> with a <em>descending</em> index defined on a <em>date of birth</em> field). The following aggregation pipeline may have then been built to show the three youngest people in the collection, only for people born on or after 1970 (so there may be less than 3 records in the result if nearly all people were born before 1970):</p>
<pre><code class="language-javascript">var pipeline = [
  {'$unset' : [
      '_id',
      'address',
      'person_id'
  ]},
  
  {'$sort' : {
      'dateofbirth' : -1
  }},
  
  {'$match' : {
      'dateofbirth' : {'$gte' : ISODate('1970-01-01T00:00:00Z')}
  }},
  
  {'$limit' : 3}
]
</code></pre>
<p>Then the <em>query planner</em> part of the explain plan might be required:</p>
<pre><code class="language-javascript">db.persons.explain('queryPlanner').aggregate(pipeline);
</code></pre>
<p>The query plan results for this pipeline shows the following (some less relevant information has been edited out for brevity)</p>
<pre><code class="language-javascript">&quot;stages&quot; : [
  {&quot;$cursor&quot; : {
    &quot;queryPlanner&quot; : {
      &quot;parsedQuery&quot; : {
        &quot;dateofbirth&quot; : {
          &quot;$gte&quot; : ISODate(&quot;1970-01-01T00:00:00Z&quot;)
        }
      },
      &quot;winningPlan&quot; : {
        &quot;stage&quot; : &quot;FETCH&quot;,
        &quot;inputStage&quot; : {
          &quot;stage&quot; : &quot;IXSCAN&quot;,
          &quot;keyPattern&quot; : {
            &quot;dateofbirth&quot; : -1
          },
          &quot;indexName&quot; : &quot;dateofbirth_-1&quot;,
          &quot;direction&quot; : &quot;forward&quot;,
          &quot;indexBounds&quot; : {
            &quot;dateofbirth&quot; : [
              &quot;[new Date(9223372036854775807), new Date(0)]&quot;
            ]
          }
        }
      }
    }
  }},
  
  {&quot;$project&quot; : {
      &quot;_id&quot; : false,
      &quot;person_id&quot; : false,
      &quot;address&quot; : false
    }
  },
  {&quot;$sort&quot; : {
      &quot;sortKey&quot; : {
        &quot;dateofbirth&quot; : -1
      },
      &quot;limit&quot; : NumberLong(3)
    }
  }
]
</code></pre>
<p>There are some interesting insights that can be deduced from this query plan:</p>
<ul>
<li>
<p>To optimise the aggregation, the database engine has reordered the pipeline and moved the filter from the <code>$match</code> to the top of the pipeline, without changing the functional behaviour or outcome of the pipeline.</p>
</li>
<li>
<p>To optimise the aggregation, the database engine has been able to collapse the <code>$sort</code> and <code>$limit</code> into a single <em>special internal</em> stage which can perform both actions in one go In this case, the aggregation engine only has to track in memory the 3 currently known youngest person records at any point in time, during the sorting process, rather than holding the whole data set being sorted in memory, which may otherwise be resource prohibitive.</p>
</li>
<li>
<p>The first stage of the executed <em>internal runtime</em> version of the pipeline, regardless of what ordered stages were placed in the pipeline by the developer, is always an <em>internal</em> <code>$cusror</code> stage. The <code>$cursor</code> <em>runtime</em> stage is the first thing that happens for any executing aggregation. The aggregation engine re-uses the MQL query engine to perform a 'regular' query against the collection, optionally including a filter based on the contents of the aggregation's <code>$match</code>, if a <code>$match</code> was defined and occurs early in the optimised pipeline. The aggregation runtime uses the resulting query cursor to pull batches of records at a time, just like a client application using a MongoDB driver would do when remotely invoking an MQL query against a database collection. As with a normal MQL query, the regular database query engine will try to use an index if it makes sense (which it does in this case, as is visible in the embedded  <code>$queryPlanner</code> metadata, showing the <code>&quot;stage&quot; : &quot;IXSCAN&quot;,</code> element and the index used, <code>&quot;indexName&quot; : &quot;dateofbirth_-1&quot;</code>). </p>
</li>
</ul>
<p>Then the <em>execution stats</em> part of the explain plan might then be asked for:</p>
<pre><code class="language-javascript">db.persons.explain('executionStats').aggregate(pipeline);
</code></pre>
<p>Below is a redacted example of the resulting execution statistics in the explain plan, highlighting some of the most important metadata elements that developers should typically focus on.</p>
<pre><code class="language-javascript">&quot;executionStats&quot; : {
  &quot;nReturned&quot; : 333333,
  &quot;totalKeysExamined&quot; : 333333,
  &quot;totalDocsExamined&quot; : 333333,
  ...
  &quot;executionStages&quot; : {
    &quot;stage&quot; : &quot;FETCH&quot;,
    &quot;nReturned&quot; : 333333,
    &quot;docsExamined&quot; : 333333,
    ...
    &quot;inputStage&quot; : {
      &quot;stage&quot; : &quot;IXSCAN&quot;,
      &quot;nReturned&quot; : 333333,
      &quot;indexName&quot; : &quot;dateofbirth_-1&quot;,
      &quot;direction&quot; : &quot;forward&quot;,
      &quot;keysExamined&quot; : 333333,
      ...
}
</code></pre>
<p>Here the plan shows that an index was used, and because 'index keys examined' and 'documents examined' match, this indicates that the index was fully leveraged to completely identify the required records, which is good news. This doesn't necessarily mean the aggregation is fully optimal though. For example, if there was the need to reduce latency further, some analysis could be done to determine if the the index can completely <a href="https://docs.mongodb.com/manual/core/query-optimization/#covered-query">cover the query</a>. If the <em>cursor query</em> part of the the aggregation is satisfied entirely using the index and does not have to examine any documents, you would see <code>totalDocsExamined = 0</code> in the resulting explain plan. </p>
<p>The critical information shown in <code>executionStats</code> is similar to the <a href="https://docs.mongodb.com/manual/tutorial/analyze-query-plan/">normal MQL explain plan</a> returned for a regular <code>find()</code> operation, and similar principles apply for spotting things like has the optimum index been used, and does the data model lend itself to efficiently processing the query?</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../guides/project.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../guides/performance.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../guides/project.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../guides/performance.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
