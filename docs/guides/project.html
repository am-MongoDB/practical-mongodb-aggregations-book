<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>To Project Or Not To Project, That Is The Question - Practical MongoDB Aggregations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../cover-page.html">Practical MongoDB Aggregations</a></li><li class="chapter-item expanded affix "><a href="../credits.html">Credits</a></li><li class="chapter-item expanded "><a href="../intro/introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro/history.html"><strong aria-hidden="true">1.1.</strong> History</a></li></ol></li><li class="chapter-item expanded "><a href="../guides/00-guides.html"><strong aria-hidden="true">2.</strong> Guiding Tips &amp; Principles</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../guides/getting-started.html"><strong aria-hidden="true">2.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../guides/getting-help.html"><strong aria-hidden="true">2.2.</strong> Getting Help</a></li><li class="chapter-item expanded "><a href="../guides/composibility.html"><strong aria-hidden="true">2.3.</strong> Embrace Composibility For Increased Productivity</a></li><li class="chapter-item expanded "><a href="../guides/project.html" class="active"><strong aria-hidden="true">2.4.</strong> To Project Or Not To Project, That Is The Question</a></li><li class="chapter-item expanded "><a href="../guides/explain.html"><strong aria-hidden="true">2.5.</strong> Using Explain Plans</a></li><li class="chapter-item expanded "><a href="../guides/performance.html"><strong aria-hidden="true">2.6.</strong> Pipeline Performance Considerations</a></li><li class="chapter-item expanded "><a href="../guides/expressions.html"><strong aria-hidden="true">2.7.</strong> Can Expressions By Used Everywhere?</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/examples.html"><strong aria-hidden="true">3.</strong> Aggregations By Example</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/simple-examples/00-simple-examples.html"><strong aria-hidden="true">3.1.</strong> Simple Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/simple-examples/filtered-top-subset.html"><strong aria-hidden="true">3.1.1.</strong> Filtered Top Subset</a></li><li class="chapter-item expanded "><a href="../examples/simple-examples/group-and-total.html"><strong aria-hidden="true">3.1.2.</strong> Group &amp; Total</a></li><li class="chapter-item expanded "><a href="../examples/simple-examples/unpack-array-group-differently.html"><strong aria-hidden="true">3.1.3.</strong> Unpack Arrays &amp; Group Differently</a></li><li class="chapter-item expanded "><a href="../examples/simple-examples/one-to-one-join.html"><strong aria-hidden="true">3.1.4.</strong> One-to-One Join</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/moderate-examples/00-moderate-examples.html"><strong aria-hidden="true">3.2.</strong> Moderate Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/moderate-examples/multi-one-to-many.html"><strong aria-hidden="true">3.2.1.</strong> Multi-Field Join &amp; One-to-Many</a></li><li class="chapter-item expanded "><a href="../examples/moderate-examples/mask-sensitive-fields.html"><strong aria-hidden="true">3.2.2.</strong> Mask Sensitive Fields</a></li><li class="chapter-item expanded "><a href="../examples/moderate-examples/largest-graph-network.html"><strong aria-hidden="true">3.2.3.</strong> Largest Graph Network</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/intricate-examples/00-intricate-examples.html"><strong aria-hidden="true">3.3.</strong> Intricate Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/intricate-examples/restricted-view.html"><strong aria-hidden="true">3.3.1.</strong> Restricted View</a></li><li class="chapter-item expanded "><a href="../examples/intricate-examples/convert-incomplete-dates.html"><strong aria-hidden="true">3.3.2.</strong> Convert Incomplete Date Strings</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Practical MongoDB Aggregations</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="to-project-or-not-to-project-that-is-the-question"><a class="header" href="#to-project-or-not-to-project-that-is-the-question">To Project Or Not To Project, That Is The Question</a></h1>
<p>The quintessential tool in MongoDB's Query Language (MQL) to specify or restrict fields to return in a query result set is a <em>projection</em>. In the MongoDB Aggregation Framework, the analogous facility for specifying fields to include or exclude in a result is the <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/">$project</a> stage. For many earlier versions of MongoDB, this was the only tool to define which fields to include and exclude, however it comes with a few usability challenges:</p>
<ol>
<li>
<p><strong><em>$project</em> is confusing and non-intuitive</strong>. In a single stage you can only choose to include fields or to exclude fields, but not both, with the exception of being able to define the <code>_id</code> field to exclude yet define other fields to include. It's as if <code>$project</code> has an identity crisis.</p>
</li>
<li>
<p><strong><em>$project</em> is verbose and inflexible</strong>. If you want to include a new field into each result record (e.g. concatenating values from two other fields together) or include a new value for an existing named field (e.g. convert text to a date), you are then forced to name all other fields in the projection for inclusion. If each record has 100 fields, and you then need to use a <code>$project</code> stage for the first time, to include a new 101st field, you also have to name all the 100 fields in the <code>$project</code> stage too. This irritation is further compounded if you have an evolving data model, where additional new fields appear in some records over time. Using <code>$project</code> for inclusion means each time a new field appears in the data-set, a developer has to go back to the old aggregation pipeline, modifying it to name the new field explicitly for inclusion in the results.</p>
</li>
</ol>
<p>In MongoDB version 4.2, the <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/set/">$set</a> and <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/unset/">$unset</a> stages were introduced, which, in most cases, are preferable to using <code>$project</code> for declaring field inclusion and exclusion respectively. They make the intent of the code far clearer, they lead to less verbose pipelines and, criticality, they reduce the need to refactor a pipeline whenever the data model evolves. How this works and guidance on when to use <code>$set</code> &amp; <code>$unset</code> stages is described in section 'When To Use $set &amp; $unset', below.</p>
<p>Despite the challenges however, there are some specific situations where using <code>$project</code> is advantageous over <code>$set</code>/<code>$unset</code>. This is described in section 'When To Use $project', below. </p>
<p>To add to the confusion, in MongoDB 3.4, a first attempt at addressing some of the disadvantages of <code>$project</code>_ was made by introducing a new <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/addFields/">$addFields</a> stage, which has the exact behaviour as <code>$set</code> (<code>$set</code> actually came later than <code>$addFields</code>). No direct equivalent to <code>$unset</code> was provided back then. Now that both <code>$set</code> and <code>$unest</code> stages are available in modern versions of MongoDB, and because their counter purposes are so obvious to deduce by their names (<code>$set</code> Vs <code>$unset</code>), <strong>it is recommended to not use <em>$addFields</em></strong>. This helps with consistency and to avoid any confusion of intent. If you have come to MongoDB only recently, just pretend <code>$addFields</code> never existed!__ 😆</p>
<h2 id="when-to-use-set--unset"><a class="header" href="#when-to-use-set--unset">When To Use Set &amp; Unset</a></h2>
<p><code>$set</code> &amp; <code>$unset</code> stages should be used when most of the fields in the input records should be retained and only a minority subset of fields need to be added, modified or removed. This is the case for the majority of uses of aggregation pipelines.</p>
<p>For example, imagine there is a collection of credit card payment records as documents similar to the following:</p>
<pre><code class="language-javascript">// INPUT  (a record from the source collection to be operated on by an aggregation)
{
  _id: ObjectId(&quot;6044faa70b2c21f8705d8954&quot;),
  card_name: 'Mrs. Jane A. Doe',
  card_num: '1234567890123456',
  card_expiry: '2023-08-31T23:59:59.736Z',
  card_sec_code: '123',
  card_provider_name: 'Credit MasterCard Gold',
  transaction_id: 'eb1bd77836e8713656d9bf2debba8900',
  transaction_date: 2021-01-13T09:32:07.000Z,
  transaction_curncy_code: 'GBP',
  transaction_amount: Decimal128(&quot;501.98&quot;),
  reported: true
}
</code></pre>
<p>Then imagine an aggregation pipeline is required, to produce modified versions of the documents, as shown below:</p>
<pre><code class="language-javascript">// OUTPUT  (a record in the results of the executed aggregation)
{
  card_name: 'Mrs. Jane A. Doe',
  card_num: '1234567890123456',
  card_expiry: 2023-08-31T23:59:59.736Z,  // Field type converted from text to date
  card_sec_code: '123',
  card_provider_name: 'Credit MasterCard Gold',
  transaction_id: 'eb1bd77836e8713656d9bf2debba8900',
  transaction_date: 2021-01-13T09:32:07.000Z,
  transaction_curncy_code: 'GBP',
  transaction_amount: Decimal128(&quot;501.98&quot;),
  reported: true,
  card_type: 'CREDIT'                     // New field added using a literal value
}
</code></pre>
<p>Here, shown by the <code>//</code> comments, there was a requirement to slightly modify the structure of each document, converting the <code>card_expiry</code> text field into a proper date field, and adding a new field <code>card_type</code> field, set to a value of 'CREDIT', for every record.</p>
<p>Naively you might decide to build an aggregation pipeline using a <code>$project</code> stage, to achieve this transformation, which would probably look similar to the following:</p>
<pre><code class="language-javascript">// BAD
[
  {'$project': {
    // Modify a field + add a new field
    'card_expiry': {'$dateFromString': {'dateString': '$card_expiry'}},
    'card_type': 'CREDIT',        

    // Must now name all the other fields for those fields to be retained
    'card_name': 1,
    'card_num': 1,
    'card_sec_code': 1,
    'card_provider_name': 1,
    'transaction_id': 1,
    'transaction_date': 1,
    'transaction_curncy_code': 1,
    'transaction_amount': 1,
    'reported': 1,                
    
    // Remove _id field
    '_id': 0,
  }},
]
</code></pre>
<p>As you can see, the pipeline's stage is quite verbose and because a <code>$project</code> stage is being used to modify/add two fields, you are forced to also explicitly name each other existing field of the source records, for inclusion, otherwise that information will be lost during the transformation. Imagine if each payment document has hundreds of possible fields, rather than just ten! </p>
<p>A better approach to building the aggregation pipeline, to achieve the exact same results, would be to use <code>$set</code> and <code>$unset</code> instead, as shown below:</p>
<pre><code class="language-javascript">// GOOD
[
  {'$set': {
    // Modified + new field
    'card_expiry': {'$dateFromString': {'dateString': '$card_expiry'}},
    'card_type': 'CREDIT',        
  }},
  
  {'$unset': [
    // Remove _id field
    '_id',
  ]},
]
</code></pre>
<p>This time, if some new documents are subsequently added to the existing payments collection, which include additional new fields, e.g. <code>settlement_date</code> &amp; <code>settlement_curncy_code'</code>, then no changes are required to the aggregation pipeline to allow these new fields to automatically appear in the existing aggregation pipeline's results. However, when using <code>$project</code>, each time the possibility of a new field arises, a developer has to first refactor the pipeline to incorporate an additional inclusion declaration (e.g. <code>'settlement_date': 1, 'settlement_curncy_code': 1</code>)</p>
<h2 id="when-to-use-project"><a class="header" href="#when-to-use-project">When To Use Project</a></h2>
<p>A <code>$project</code> stage should be used when the required output shape of result documents is very different than the shape of input documents, where most of the original fields are not to be included in the output.</p>
<p>This time for the same input payments collection, lets imagine a different aggregation pipeline was required to produce result documents, where each document's structure is required to be very different than the input structure, with far fewer field values need to be pulled through from the original input documents, similar to the following:</p>
<pre><code class="language-javascript">// OUTPUT  (a record in the results of the executed aggregation)
{
  transaction_info: { 
    date: 2021-01-13T09:32:07.000Z,
    amount: Decimal128(&quot;501.98&quot;)
  },
  status: 'REPORTED'
}
</code></pre>
<p>Now, using <code>$set</code>/<code>$unset</code> in the pipeline to achieve the above output structure would be verbose and would require naming all the fields (for exclusion this time). as shown below:</p>
<pre><code class="language-javascript">// BAD
[
  {'$set': {
    'transaction_info.date': '$transaction_date',
    'transaction_info.amount': '$transaction_amount',
    'status': {'$cond': {'if': '$reported', 'then': 'REPORTED', 'else': 'UNREPORTED'}},
  }},
  
  {'$unset': [
    // Remove _id field
    '_id',

    // Must name all existing fields to be omitted
    'card_name',
    'card_num',
    'card_expiry',
    'card_sec_code',
    'card_provider_name',
    'transaction_id',
    'transaction_date',
    'transaction_curncy_code',
    'transaction_amount',
    'reported',         
  ]}, 
]
</code></pre>
<p>However, by using <code>$project</code> for this specific aggregation, as shown below, to achieve the exact same results, the pipeline would be less verbose and have the flexibility of not requiring modification if subsequent additions are ever made to the data model, with new previously unknown fields:</p>
<pre><code class="language-javascript">// GOOD
[
  {'$project': {
    'transaction_info.date': '$transaction_date',
    'transaction_info.amount': '$transaction_amount',
    'status': {'$cond': {'if': '$reported', 'then': 'REPORTED', 'else': 'UNREPORTED'}},
    
    // Remove _id field
    '_id': 0,
  }},
]
</code></pre>
<h2 id="main-takeaway"><a class="header" href="#main-takeaway">Main Takeaway</a></h2>
<p>In summary, always look to use <code>$set</code> &amp; <code>$unset</code> for field inclusion and exclusion, rather than <code>$project</code>, unless it is very clear that a complete new structure is required for result documents, with very few of the input fields required. Don't bother using <code>$addFields</code> nowadays because it adds no value and may just cause confusion.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../guides/composibility.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../guides/explain.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../guides/composibility.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../guides/explain.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
